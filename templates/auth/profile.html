{% extends "base.html" %}
{% block title %}Profil u≈ºytkownika - CV Optimizer Pro{% endblock %}

{% block content %}
<div class="container-fluid min-vh-100" style="background: var(--hero-gradient); padding-top: 100px; padding-bottom: 40px;">
    <div class="container">
        <!-- Header Profile Card -->
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-10">
                <div class="card shadow-lg border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                            <div class="d-flex align-items-center mb-3 mb-md-0">
                                <div class="position-relative me-4">
                                    <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center shadow-lg" 
                                         style="width: 80px; height: 80px; background: var(--primary-gradient);">
                                        <i class="bi bi-person-circle text-white" style="font-size: 2.5rem;"></i>
                                    </div>
                                    {% if stats.is_premium %}
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning">
                                        <i class="bi bi-star-fill"></i>
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                    <h2 class="mb-1 fw-bold text-dark">{{ current_user.first_name }} {{ current_user.last_name }}</h2>
                                    <p class="text-muted mb-1">@{{ current_user.username }}</p>
                                    <p class="text-muted mb-0">
                                        <i class="bi bi-envelope me-2"></i>{{ current_user.email }}
                                    </p>
                                    <p class="text-muted mb-0">
                                        <i class="bi bi-calendar me-2"></i>Do≈ÇƒÖczy≈Ç {{ stats.account_age }} dni temu
                                    </p>
                                </div>
                            </div>

                            <div class="d-flex flex-column align-items-end">
                                {% if stats.is_premium %}
                                <div class="badge bg-warning text-dark px-3 py-2 rounded-pill mb-2">
                                    <i class="bi bi-star-fill me-1"></i>Konto Premium
                                </div>
                                {% else %}
                                <div class="badge bg-secondary px-3 py-2 rounded-pill mb-2">
                                    <i class="bi bi-person me-1"></i>Konto Basic
                                </div>
                                {% endif %}

                                {% if stats.last_login %}
                                <small class="text-muted">
                                    Ostatnie logowanie: {{ stats.last_login.strftime('%d.%m.%Y %H:%M') }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productivity Score Section -->
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-10">
                <div class="card border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-body p-4">
                        <h4 class="mb-3">üöÄ Wska≈∫nik Produktywno≈õci</h4>
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="flex-grow-1 me-4">
                                <div class="progress" style="height: 15px; border-radius: 10px;">
                                    <div class="progress-bar bg-gradient" 
                                         style="width: {{ stats.productivity_score }}%; 
                                                background: linear-gradient(45deg, #6366f1, #8b5cf6);"
                                         role="progressbar">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <small class="text-muted">PoczƒÖtkujƒÖcy</small>
                                    <small class="text-muted">Ekspert</small>
                                </div>
                            </div>
                            <div class="text-center">
                                <h2 class="fw-bold text-primary mb-0">{{ stats.productivity_score }}%</h2>
                                <small class="text-muted">Poziom</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                üí° Zaoszczƒôdzi≈Çe≈õ oko≈Ço <strong>{{ stats.time_saved_hours }} godzin</strong> 
                                dziƒôki CV Optimizer Pro!
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievements Section -->
        {% if stats.achievements %}
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-10">
                <div class="card border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-body p-4">
                        <h4 class="mb-3">üèÜ OsiƒÖgniƒôcia</h4>
                        <div class="row g-3">
                            {% for achievement in stats.achievements %}
                            <div class="col-md-6 col-lg-4">
                                <div class="d-flex align-items-center p-3 rounded-3" 
                                     style="background: rgba(var(--bs-{{ achievement.color }}-rgb), 0.1);">
                                    <div class="badge bg-{{ achievement.color }} rounded-circle me-3" 
                                         style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi {{ achievement.icon }}" style="font-size: 1.2rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold">{{ achievement.name }}</h6>
                                        <small class="text-muted">{{ achievement.description }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Statistics Cards Row -->
        <div class="row justify-content-center g-4 mb-5">
            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-file-earmark-text text-white"></i>
                        </div>
                        <h3 class="fw-bold text-primary mb-1">{{ stats.cv_count }}</h3>
                        <p class="small text-muted mb-0">Przes≈Çane CV</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-magic text-white"></i>
                        </div>
                        <h3 class="fw-bold text-success mb-1">{{ stats.optimized_count }}</h3>
                        <p class="small text-muted mb-0">Zoptymalizowane</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-info rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-graph-up text-white"></i>
                        </div>
                        <h3 class="fw-bold text-info mb-1">{{ stats.analyzed_count }}</h3>
                        <p class="small text-muted mb-0">Przeanalizowane</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-speedometer2 text-white"></i>
                        </div>
                        <h3 class="fw-bold text-warning mb-1">{{ stats.success_rate }}%</h3>
                        <p class="small text-muted mb-0">Skuteczno≈õƒá</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-activity text-white"></i>
                        </div>
                        <h3 class="fw-bold text-danger mb-1">{{ stats.recent_activity }}</h3>
                        <p class="small text-muted mb-0">Ostatnie 30 dni</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Statistics Row -->
        <div class="row justify-content-center g-4 mb-5">
            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-envelope-heart text-white"></i>
                        </div>
                        <h3 class="fw-bold text-success mb-1">{{ stats.advanced.cover_letters }}</h3>
                        <p class="small text-muted mb-0">Listy motywacyjne</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-info rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-question-circle text-white"></i>
                        </div>
                        <h3 class="fw-bold text-info mb-1">{{ stats.advanced.interview_questions }}</h3>
                        <p class="small text-muted mb-0">Pytania rekrutacyjne</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-bar-chart text-white"></i>
                        </div>
                        <h3 class="fw-bold text-warning mb-1">{{ stats.advanced.skills_analyses }}</h3>
                        <p class="small text-muted mb-0">Analizy kompetencji</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-purple rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px; background: #8b5cf6;">
                            <i class="bi bi-cash-coin text-white"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #8b5cf6;">{{ stats.advanced.total_spent_pln }}z≈Ç</h3>
                        <p class="small text-muted mb-0">Zainwestowano</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Statistics Row -->
        <div class="row justify-content-center g-4 mb-5">
            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px; background: var(--primary-gradient);">
                            <i class="bi bi-box-arrow-in-right text-white"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #8b5cf6;">{{ stats.total_logins }}</h3>
                        <p class="small text-muted mb-0">Liczba logowa≈Ñ</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px; background: var(--success-gradient);">
                            <i class="bi bi-clock text-white"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #06b6d4;">{{ stats.total_time_spent }}</h3>
                        <p class="small text-muted mb-0">Minut w aplikacji</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px; background: var(--warning-gradient);">
                            <i class="bi bi-heart text-white"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #f43f5e;">
                            {% if stats.cv_count > 0 %}{{ (stats.optimized_count / stats.cv_count * 100)|round(0)|int }}{% else %}0{% endif %}%
                        </h3>
                        <p class="small text-muted mb-0">Poziom zadowolenia</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px; background: var(--success-gradient);">
                            <i class="bi bi-trophy text-white"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #14b8a6;">
                            {% if stats.account_age < 7 %}Nowicjusz{% elif stats.account_age < 30 %}Aktywny{% elif stats.account_age < 90 %}Ekspert{% else %}Mistrz{% endif %}
                        </h3>
                        <p class="small text-muted mb-0">Status u≈ºytkownika</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics and Recent Activity -->
        <div class="row justify-content-center g-4">
            <!-- Progress Chart Card -->
            <div class="col-lg-5">
                <div class="card h-100 border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-header border-0 bg-transparent pb-0">
                        <div class="d-flex align-items-center p-3 pb-2">
                            <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px; background: var(--primary-gradient);">
                                <i class="bi bi-bar-chart text-white"></i>
                            </div>
                            <div>
                                <h4 class="card-title mb-1 fw-bold text-dark">Postƒôp Optymalizacji</h4>
                                <p class="mb-0 text-muted">Twoja skuteczno≈õƒá w liczbach</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4 pt-2">
                        <!-- Success Rate Circle -->
                        <div class="text-center mb-4">
                            <div class="position-relative d-inline-block">
                                <svg width="120" height="120" class="progress-ring">
                                    <circle cx="60" cy="60" r="50" stroke="#e9ecef" stroke-width="8" fill="transparent"/>
                                    <circle cx="60" cy="60" r="50" stroke="url(#gradient)" stroke-width="8" fill="transparent"
                                            stroke-dasharray="{{ (stats.success_rate / 100) * 314 }} 314" stroke-linecap="round"
                                            style="transform: rotate(-90deg); transform-origin: 60px 60px;"/>
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" style="stop-color:#667eea"/>
                                            <stop offset="100%" style="stop-color:#764ba2"/>
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <div class="fw-bold h3 text-primary">{{ stats.success_rate }}%</div>
                                    <small class="text-muted">Skuteczno≈õƒá</small>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Bars -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Zoptymalizowane</span>
                                <span class="fw-bold">{{ stats.optimized_count }}/{{ stats.cv_count }}</span>
                            </div>
                            <div class="progress" style="height: 8px; border-radius: 10px;">
                                <div class="progress-bar bg-success" style="width: {% if stats.cv_count > 0 %}{{ (stats.optimized_count / stats.cv_count) * 100 }}{% else %}0{% endif %}%; border-radius: 10px;"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Przeanalizowane</span>
                                <span class="fw-bold">{{ stats.analyzed_count }}/{{ stats.cv_count }}</span>
                            </div>
                            <div class="progress" style="height: 8px; border-radius: 10px;">
                                <div class="progress-bar bg-info" style="width: {% if stats.cv_count > 0 %}{{ (stats.analyzed_count / stats.cv_count) * 100 }}{% else %}0{% endif %}%; border-radius: 10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Card -->
            <div class="col-lg-5">
                <div class="card h-100 border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-header border-0 bg-transparent pb-0">
                        <div class="d-flex align-items-center p-3 pb-2">
                            <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px; background: var(--primary-gradient);">
                                <i class="bi bi-clock-history text-white"></i>
                            </div>
                            <div>
                                <h4 class="card-title mb-1 fw-bold text-dark">Ostatnia Aktywno≈õƒá</h4>
                                <p class="mb-0 text-muted">Twoje najnowsze CV</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4 pt-2">
                        {% if recent_cvs %}
                        <div class="timeline">
                            {% for cv in recent_cvs %}
                            <div class="d-flex align-items-start mb-3">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3 flex-shrink-0" 
                                     style="width: 35px; height: 35px;">
                                    <i class="bi bi-file-earmark-text text-white" style="font-size: 0.9rem;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-1 text-dark">{{ cv.job_title }}</h6>
                                    <p class="text-muted mb-1 small">{{ cv.filename }}</p>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted me-3">
                                            <i class="bi bi-calendar me-1"></i>{{ cv.created_at.strftime('%d.%m.%Y') }}
                                        </small>
                                        {% if cv.optimized_cv %}
                                        <span class="badge bg-success rounded-pill">Zoptymalizowane</span>
                                        {% endif %}
                                        {% if cv.cv_analysis %}
                                        <span class="badge bg-info rounded-pill ms-1">Przeanalizowane</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% if not loop.last %}
                            <hr class="my-2 opacity-25">
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-file-earmark-x text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">Nie przes≈Çano jeszcze ≈ºadnego CV</p>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-sm">
                                <i class="bi bi-upload me-1"></i>Prze≈õlij pierwsze CV
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Analytics Section -->
        <div class="row justify-content-center g-4 mb-5">
            <!-- Monthly Activity Chart -->
            <div class="col-lg-7">
                <div class="card border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-header border-0 bg-transparent pb-0">
                        <div class="d-flex align-items-center p-3 pb-2">
                            <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px; background: var(--primary-gradient);">
                                <i class="bi bi-graph-up text-white"></i>
                            </div>
                            <div>
                                <h4 class="card-title mb-1 fw-bold text-dark">üìà Aktywno≈õƒá miesiƒôczna</h4>
                                <p class="mb-0 text-muted">Twoje CV w czasie</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4 pt-2">
                        <canvas id="monthlyChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Popular Jobs & Export -->
            <div class="col-lg-5">
                <div class="card h-100 border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-header border-0 bg-transparent pb-0">
                        <div class="d-flex align-items-center justify-content-between p-3 pb-2">
                            <div class="d-flex align-items-center">
                                <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" 
                                     style="width: 50px; height: 50px; background: var(--success-gradient);">
                                    <i class="bi bi-briefcase text-white"></i>
                                </div>
                                <div>
                                    <h4 class="card-title mb-1 fw-bold text-dark">üéØ Popularne stanowiska</h4>
                                    <p class="mb-0 text-muted">Najczƒô≈õciej aplikujesz na</p>
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-primary rounded-pill" type="button" id="exportDropdown" data-bs-toggle="dropdown">
                                    <i class="bi bi-download me-1"></i>Eksport
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportProfileData('pdf')">
                                        <i class="bi bi-file-earmark-pdf me-2"></i>PDF
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportProfileData('csv')">
                                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4 pt-2">
                        {% if stats.advanced.popular_jobs %}
                        <div class="space-y-3">
                            {% for job in stats.advanced.popular_jobs %}
                            <div class="d-flex align-items-center justify-content-between p-3 rounded-3 mb-3" 
                                 style="background: rgba(var(--bs-primary-rgb), 0.05);">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 35px; height: 35px;">
                                        <span class="text-white fw-bold">{{ loop.index }}</span>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold">{{ job.title }}</h6>
                                        <small class="text-muted">{{ job.count }} CV</small>
                                    </div>
                                </div>
                                <div class="badge bg-primary rounded-pill">{{ job.count }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-briefcase display-4 text-muted opacity-25"></i>
                            <p class="text-muted mt-3">Prze≈õlij wiƒôcej CV, aby zobaczyƒá statystyki</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities Timeline -->
        {% if recent_activities %}
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-10">
                <div class="card border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-header border-0 bg-transparent pb-0">
                        <div class="d-flex align-items-center p-3 pb-2">
                            <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px; background: var(--info-gradient);">
                                <i class="bi bi-activity text-white"></i>
                            </div>
                            <div>
                                <h4 class="card-title mb-1 fw-bold text-dark">üïí Ostatnie aktywno≈õci</h4>
                                <p class="mb-0 text-muted">Twoja historia dzia≈Ça≈Ñ</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4 pt-2">
                        <div class="timeline">
                            {% for activity in recent_activities %}
                            <div class="d-flex align-items-start mb-3">
                                <div class="bg-{{ activity.color }} rounded-circle d-flex align-items-center justify-content-center me-3 flex-shrink-0" 
                                     style="width: 40px; height: 40px;">
                                    <i class="bi {{ activity.icon }} text-white"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-1 text-dark">{{ activity.title }}</h6>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted">
                                            <i class="bi bi-calendar me-1"></i>{{ activity.date.strftime('%d.%m.%Y %H:%M') }}
                                        </small>
                                        <span class="badge bg-{{ activity.color }} rounded-pill ms-2 opacity-75">{{ activity.type }}</span>
                                    </div>
                                </div>
                            </div>
                            {% if not loop.last %}
                            <hr class="my-2 opacity-25">
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="row justify-content-center mt-4">
            <div class="col-12 col-lg-10">
                <div class="card border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-body p-4 text-center">
                        <h5 class="mb-3 fw-bold text-dark">ZarzƒÖdzaj swoim kontem</h5>
                        <div class="d-flex flex-wrap justify-content-center gap-3">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-primary px-4 py-2" style="border-radius: 12px;">
                                <i class="bi bi-speedometer2 me-2"></i>Dashboard
                            </a>
                            {% if not stats.is_premium %}
                            <a href="{{ url_for('pricing') }}" class="btn btn-warning px-4 py-2" style="border-radius: 12px;">
                                <i class="bi bi-star me-2"></i>Przejd≈∫ na Premium
                            </a>
                            {% endif %}
                            <a href="{{ url_for('logout') }}" class="btn btn-outline-light px-4 py-2" style="border-radius: 12px;">
                                <i class="bi bi-box-arrow-right me-2"></i>Wyloguj siƒô
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status p≈Çatno≈õci -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-credit-card text-success"></i> Status p≈Çatno≈õci</h5>
                    </div>
                    <div class="card-body">
                        {% set payment_status = current_user.get_payment_status() %}

                        {% if payment_status.type == 'developer' %}
                            <div class="alert alert-info">
                                <i class="fas fa-code"></i> <strong>Konto deweloperskie</strong> - pe≈Çny dostƒôp do wszystkich funkcji
                            </div>
                        {% elif payment_status.type == 'subscription' %}
                            <div class="alert alert-success">
                                <i class="fas fa-crown"></i> <strong>Aktywna subskrypcja:</strong> {{ payment_status.plan }}
                                <br><small>Wygasa: {{ payment_status.expires.strftime('%d.%m.%Y') }}</small>
                            </div>
                            <a href="{{ url_for('pricing') }}" class="btn btn-outline-primary">
                                <i class="fas fa-cog"></i> ZarzƒÖdzaj subskrypcjƒÖ
                            </a>
                        {% elif payment_status.type == 'single' %}
                            <div class="alert alert-warning">
                                <i class="fas fa-ticket-alt"></i> <strong>Jednorazowa p≈Çatno≈õƒá</strong>
                                <br>Pozosta≈Ço optymalizacji CV: <strong>{{ payment_status.optimizations_left }}</strong>
                            </div>
                            <a href="{{ url_for('pricing') }}" class="btn btn-success">
                                <i class="fas fa-upgrade"></i> Przejd≈∫ na pe≈Çny pakiet
                            </a>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-user"></i> <strong>Konto darmowe</strong>
                                <br>Brak aktywnych p≈Çatno≈õci
                            </div>
                            <a href="{{ url_for('pricing') }}" class="btn btn-primary">
                                <i class="fas fa-shopping-cart"></i> Zobacz cennik
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js Library - using most reliable CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animacja dla k√≥≈Ç postƒôpu
    const progressRings = document.querySelectorAll('.progress-ring circle:nth-child(2)');
    progressRings.forEach(ring => {
        const dashArray = ring.style.strokeDasharray;
        ring.style.strokeDasharray = '0 314';
        setTimeout(() => {
            ring.style.strokeDasharray = dashArray;
            ring.style.transition = 'stroke-dasharray 2s ease-in-out';
        }, 500);
    });

    // Animacja dla pask√≥w postƒôpu
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
            bar.style.transition = 'width 1.5s ease-in-out';
        }, 800);
    });

    // Chart.js Monthly Activity Chart with robust data handling
    const monthlyChartCtx = document.getElementById('monthlyChart');
    if (monthlyChartCtx) {
        // Safely parse monthly data with fallbacks
        let monthlyData;
        try {
            monthlyData = {{ stats.advanced.monthly_activity | tojson | safe }};
            // Validate data structure
            if (!Array.isArray(monthlyData)) {
                monthlyData = [];
            }
        } catch (e) {
            console.warn('Error parsing monthly activity data:', e);
            monthlyData = [];
        }
        
        // Handle empty data case
        if (monthlyData.length === 0) {
            monthlyData = [
                { month: 'Brak danych', count: 0 }
            ];
        }
        
        new Chart(monthlyChartCtx, {
            type: 'line',
            data: {
                labels: monthlyData.map(item => item.month || 'Nieznany'),
                datasets: [{
                    label: 'CV przes≈Çane',
                    data: monthlyData.map(item => item.count || 0),
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgb(99, 102, 241)',
                    pointBorderColor: 'white',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            color: '#6b7280'
                        },
                        grid: {
                            color: 'rgba(107, 114, 128, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#6b7280'
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                elements: {
                    point: {
                        hoverBackgroundColor: 'rgb(99, 102, 241)'
                    }
                }
            }
        });
    }
});

// Export functionality with robust error handling
function exportProfileData(format) {
    // Safely construct user data with proper escaping and fallbacks
    const userData = {
        name: {{ (current_user.first_name + ' ' + current_user.last_name) | tojson | safe }},
        email: {{ current_user.email | tojson | safe }},
        exportDate: new Date().toISOString().slice(0, 19).replace('T', ' '),
        stats: {
            cv_count: {{ stats.cv_count | default(0) }},
            optimized_count: {{ stats.optimized_count | default(0) }},
            analyzed_count: {{ stats.analyzed_count | default(0) }},
            success_rate: {{ stats.success_rate | default(0) }},
            productivity_score: {{ stats.productivity_score | default(0) }},
            time_saved_hours: {{ stats.time_saved_hours | default(0) }},
            account_age_days: {{ stats.account_age | default(0) }},
            cover_letters: {{ stats.advanced.cover_letters | default(0) }},
            interview_questions: {{ stats.advanced.interview_questions | default(0) }},
            skills_analyses: {{ stats.advanced.skills_analyses | default(0) }},
            total_spent: {{ stats.advanced.total_spent_pln | default(0) }},
            total_logins: {{ stats.total_logins | default(0) }},
            total_time_spent: {{ stats.total_time_spent | default(0) }}
        },
        popular_jobs: {{ stats.advanced.popular_jobs | default([]) | tojson | safe }},
        achievements: {{ stats.achievements | default([]) | tojson | safe }},
        monthly_activity: {{ stats.advanced.monthly_activity | default([]) | tojson | safe }}
    };

    // Validate data before export
    if (!userData.name || userData.name.trim() === '') {
        userData.name = 'U≈ºytkownik CV Optimizer Pro';
    }
    
    if (!userData.email || userData.email.trim() === '') {
        alert('B≈ÇƒÖd: Brak danych email do eksportu');
        return;
    }

    if (format === 'pdf') {
        exportToPDF(userData);
    } else if (format === 'csv') {
        exportToCSV(userData);
    }
}

function exportToPDF(data) {
    try {
        // Validate data before proceeding
        if (!data || !data.stats) {
            alert('B≈ÇƒÖd: Brak danych do eksportu');
            return;
        }

        // Safely escape data for HTML
        const safeName = (data.name || 'U≈ºytkownik').replace(/[<>&"]/g, '');
        const safeEmail = (data.email || 'brak@email.com').replace(/[<>&"]/g, '');
        const exportDate = new Date().toLocaleDateString('pl-PL');
        const exportTime = new Date().toLocaleTimeString('pl-PL');
        
        // Create a printable version of the profile
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            alert('Popup zosta≈Ç zablokowany. Proszƒô zezwoliƒá na popup dla tej strony.');
            return;
        }

        printWindow.document.write(`
            <html>
            <head>
                <title>Raport Profilu CV Optimizer Pro - ${safeName}</title>
                <meta charset="UTF-8">
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                    .header { border-bottom: 3px solid #6366f1; padding-bottom: 15px; margin-bottom: 25px; }
                    .export-info { color: #666; font-size: 12px; margin-bottom: 20px; }
                    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
                    .stat-card { border: 2px solid #e5e7eb; padding: 15px; border-radius: 8px; background: #f9fafb; }
                    .stat-card h3 { margin: 0 0 10px 0; color: #374151; font-size: 14px; }
                    .stat-value { font-size: 24px; font-weight: bold; margin: 5px 0; }
                    .achievements { margin: 25px 0; }
                    .achievement { background: #f3f4f6; padding: 12px; margin: 8px 0; border-radius: 5px; border-left: 4px solid #6366f1; }
                    .popular-jobs { margin: 25px 0; }
                    .monthly-activity { margin: 25px 0; }
                    @media print {
                        body { margin: 10px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>CV Optimizer Pro - Raport Profilu</h1>
                    <h2>${safeName}</h2>
                    <p><strong>Email:</strong> ${safeEmail}</p>
                    <div class="export-info">
                        <p>Data wygenerowania: ${exportDate} ${exportTime}</p>
                        <p>Wiek konta: ${data.stats.account_age_days || 0} dni</p>
                    </div>
                </div>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <h3>üìÑ Przes≈Çane CV</h3>
                        <div class="stat-value" style="color: #6366f1;">${data.stats.cv_count || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>‚úÖ Zoptymalizowane</h3>
                        <div class="stat-value" style="color: #059669;">${data.stats.optimized_count || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>üìä Przeanalizowane</h3>
                        <div class="stat-value" style="color: #0891b2;">${data.stats.analyzed_count || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>üéØ Wska≈∫nik sukcesu</h3>
                        <div class="stat-value" style="color: #dc2626;">${data.stats.success_rate || 0}%</div>
                    </div>
                    <div class="stat-card">
                        <h3>‚ö° Produktywno≈õƒá</h3>
                        <div class="stat-value" style="color: #8b5cf6;">${data.stats.productivity_score || 0}%</div>
                    </div>
                    <div class="stat-card">
                        <h3>‚è∞ Zaoszczƒôdzony czas</h3>
                        <div class="stat-value" style="color: #f59e0b;">${data.stats.time_saved_hours || 0}h</div>
                    </div>
                    <div class="stat-card">
                        <h3>‚úâÔ∏è Listy motywacyjne</h3>
                        <div class="stat-value" style="color: #10b981;">${data.stats.cover_letters || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>‚ùì Pytania rekrutacyjne</h3>
                        <div class="stat-value" style="color: #06b6d4;">${data.stats.interview_questions || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>üìà Analizy kompetencji</h3>
                        <div class="stat-value" style="color: #8b5cf6;">${data.stats.skills_analyses || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>üí∞ Zainwestowano</h3>
                        <div class="stat-value" style="color: #059669;">${data.stats.total_spent || 0} z≈Ç</div>
                    </div>
                </div>

                ${data.achievements && data.achievements.length > 0 ? `
                <div class="achievements">
                    <h3>üèÜ OsiƒÖgniƒôcia (${data.achievements.length})</h3>
                    ${data.achievements.map(achievement => `
                        <div class="achievement">
                            <strong>${(achievement.name || 'Nieznane osiƒÖgniƒôcie').replace(/[<>&"]/g, '')}</strong> - 
                            ${(achievement.description || 'Brak opisu').replace(/[<>&"]/g, '')}
                        </div>
                    `).join('')}
                </div>
                ` : '<div class="achievements"><h3>üèÜ OsiƒÖgniƒôcia</h3><p>Brak osiƒÖgniƒôƒá do wy≈õwietlenia</p></div>'}

                ${data.popular_jobs && data.popular_jobs.length > 0 ? `
                <div class="popular-jobs">
                    <h3>üéØ Najpopularniejsze stanowiska (${data.popular_jobs.length})</h3>
                    ${data.popular_jobs.map((job, index) => `
                        <p><strong>${index + 1}.</strong> ${(job.title || 'Nieznane stanowisko').replace(/[<>&"]/g, '')} (${job.count || 0} CV)</p>
                    `).join('')}
                </div>
                ` : '<div class="popular-jobs"><h3>üéØ Popularne stanowiska</h3><p>Brak danych o stanowiskach</p></div>'}

                ${data.monthly_activity && data.monthly_activity.length > 0 ? `
                <div class="monthly-activity">
                    <h3>üìÖ Aktywno≈õƒá miesiƒôczna</h3>
                    ${data.monthly_activity.map(activity => `
                        <p><strong>${(activity.month || 'Nieznany miesiƒÖc').replace(/[<>&"]/g, '')}:</strong> ${activity.count || 0} CV</p>
                    `).join('')}
                </div>
                ` : ''}

                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #666; font-size: 12px;">
                    <p>Ten raport zosta≈Ç wygenerowany automatycznie przez CV Optimizer Pro.</p>
                    <p>Wszelkie dane dotyczƒÖ okresu od za≈Ço≈ºenia konta do daty eksportu.</p>
                </div>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Wait for content to load before printing
        setTimeout(() => {
            printWindow.print();
        }, 500);
        
    } catch (error) {
        console.error('Error exporting to PDF:', error);
        alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas eksportu do PDF. Proszƒô spr√≥bowaƒá ponownie.');
    }
}

function exportToCSV(data) {
    try {
        // Validate data before proceeding
        if (!data || !data.stats) {
            alert('B≈ÇƒÖd: Brak danych do eksportu CSV');
            return;
        }

        // Safely construct CSV data with proper escaping
        const csvData = [
            ['Sekcja', 'Nazwa', 'Warto≈õƒá'],
            ['Podstawowe', 'Data eksportu', data.exportDate || new Date().toISOString().slice(0, 19).replace('T', ' ')],
            ['Podstawowe', 'Imiƒô i nazwisko', data.name || 'Nieznane'],
            ['Podstawowe', 'Email', data.email || 'brak@email.com'],
            ['Podstawowe', 'Wiek konta (dni)', data.stats.account_age_days || 0],
            ['', '', ''], // Separator
            ['Statystyki CV', 'Przes≈Çane CV', data.stats.cv_count || 0],
            ['Statystyki CV', 'Zoptymalizowane CV', data.stats.optimized_count || 0],
            ['Statystyki CV', 'Przeanalizowane CV', data.stats.analyzed_count || 0],
            ['Statystyki CV', 'Wska≈∫nik sukcesu (%)', data.stats.success_rate || 0],
            ['', '', ''], // Separator
            ['Produktywno≈õƒá', 'Wska≈∫nik produktywno≈õci (%)', data.stats.productivity_score || 0],
            ['Produktywno≈õƒá', 'Zaoszczƒôdzony czas (h)', data.stats.time_saved_hours || 0],
            ['Produktywno≈õƒá', 'Liczba logowa≈Ñ', data.stats.total_logins || 0],
            ['Produktywno≈õƒá', 'Czas spƒôdzony (min)', data.stats.total_time_spent || 0],
            ['', '', ''], // Separator
            ['Zaawansowane', 'Listy motywacyjne', data.stats.cover_letters || 0],
            ['Zaawansowane', 'Pytania rekrutacyjne', data.stats.interview_questions || 0],
            ['Zaawansowane', 'Analizy kompetencji', data.stats.skills_analyses || 0],
            ['Zaawansowane', 'Zainwestowano (z≈Ç)', data.stats.total_spent || 0]
        ];

        // Add popular jobs if available
        if (data.popular_jobs && data.popular_jobs.length > 0) {
            csvData.push(['', '', '']); // Separator
            csvData.push(['Stanowiska', 'Pozycja', 'Nazwa stanowiska', 'Liczba CV']);
            data.popular_jobs.forEach((job, index) => {
                csvData.push(['Stanowiska', index + 1, job.title || 'Nieznane stanowisko', job.count || 0]);
            });
        }

        // Add achievements if available
        if (data.achievements && data.achievements.length > 0) {
            csvData.push(['', '', '']); // Separator
            csvData.push(['OsiƒÖgniƒôcia', 'Nazwa osiƒÖgniƒôcia', 'Opis']);
            data.achievements.forEach(achievement => {
                csvData.push(['OsiƒÖgniƒôcia', 
                    achievement.name || 'Nieznane osiƒÖgniƒôcie', 
                    achievement.description || 'Brak opisu'
                ]);
            });
        }

        // Add monthly activity if available
        if (data.monthly_activity && data.monthly_activity.length > 0) {
            csvData.push(['', '', '']); // Separator
            csvData.push(['Aktywno≈õƒá', 'MiesiƒÖc', 'Liczba CV']);
            data.monthly_activity.forEach(activity => {
                csvData.push(['Aktywno≈õƒá', 
                    activity.month || 'Nieznany miesiƒÖc', 
                    activity.count || 0
                ]);
            });
        }

        // Create CSV content with proper escaping
        const csvContent = csvData.map(row => 
            row.map(cell => {
                // Convert to string and escape quotes
                const cellStr = String(cell || '');
                return `"${cellStr.replace(/"/g, '""')}"`; // Proper CSV quote escaping
            }).join(',')
        ).join('\\n');

        // Add BOM for proper UTF-8 encoding in Excel
        const csvContentWithBOM = '\\uFEFF' + csvContent;

        // Create and download file
        const blob = new Blob([csvContentWithBOM], { 
            type: 'text/csv;charset=utf-8;' 
        });
        
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        // Generate safe filename with timestamp
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '_');
        const filename = `cv_optimizer_profil_${timestamp}.csv`;
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        
        link.click();
        
        // Cleanup
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 100);
        
        console.log('CSV export completed successfully');
        
    } catch (error) {
        console.error('Error exporting to CSV:', error);
        alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas eksportu do CSV. Proszƒô spr√≥bowaƒá ponownie.');
    }
}
</script>
{% endblock %}