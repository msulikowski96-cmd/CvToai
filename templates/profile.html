
{% extends "base.html" %}

{% block title %}Profil - CV Optimizer Pro{% endblock %}

{% block content %}
<!-- Profile Header -->
<section class="hero-section text-white position-relative overflow-hidden">
    <div class="hero-bg"></div>
    <div class="container py-4 position-relative">
        <div class="row align-items-center">
            <div class="col-auto">
                <div class="profile-avatar bg-primary-gradient rounded-circle d-flex align-items-center justify-content-center">
                    <span class="h2 mb-0 text-white fw-bold">
                        {{ current_user.first_name[0].upper() }}{% if current_user.last_name %}{{ current_user.last_name[0].upper() }}{% endif %}
                    </span>
                </div>
            </div>
            <div class="col">
                <h1 class="h3 fw-bold mb-1">{{ current_user.first_name }} {{ current_user.last_name or '' }}</h1>
                <p class="text-white-75 mb-0">@{{ current_user.username }}</p>
                <small class="text-white-50">
                    <i class="bi bi-calendar me-1"></i>
                    Członek od {{ current_user.created_at.strftime('%B %Y') }}
                </small>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('index') }}" class="btn btn-outline-light rounded-pill px-4">
                    <i class="bi bi-arrow-left me-2"></i>Powrót
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Profile Content -->
<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <!-- Profile Form -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm glassmorphism">
                    <div class="card-header bg-transparent border-0 p-4">
                        <h3 class="h4 fw-bold mb-0">
                            <i class="bi bi-person-gear text-primary me-2"></i>
                            Ustawienia profilu
                        </h3>
                    </div>
                    
                    <div class="card-body p-4">
                        <form id="profileForm">
                            {{ form.hidden_tag() }}
                            
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <label for="first_name" class="form-label fw-semibold">Imię</label>
                                    {{ form.first_name(class="form-control form-control-lg") }}
                                    {% if form.first_name.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.first_name.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="last_name" class="form-label fw-semibold">Nazwisko</label>
                                    {{ form.last_name(class="form-control form-control-lg") }}
                                    {% if form.last_name.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.last_name.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="email" class="form-label fw-semibold">Adres email</label>
                                {{ form.email(class="form-control form-control-lg") }}
                                {% if form.email.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.email.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-4">
                                <label for="username" class="form-label fw-semibold">Nazwa użytkownika</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">@</span>
                                    {{ form.username(class="form-control") }}
                                </div>
                                {% if form.username.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.username.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-shield-lock text-warning me-2"></i>
                                Zmiana hasła
                            </h5>
                            
                            <div class="mb-3">
                                <label for="current_password" class="form-label fw-semibold">Obecne hasło</label>
                                {{ form.current_password(class="form-control") }}
                                {% if form.current_password.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.current_password.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Wymagane tylko przy zmianie hasła</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="new_password" class="form-label fw-semibold">Nowe hasło</label>
                                    {{ form.new_password(class="form-control") }}
                                    {% if form.new_password.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.new_password.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="confirm_password" class="form-label fw-semibold">Potwierdź hasło</label>
                                    {{ form.confirm_password(class="form-control") }}
                                    {% if form.confirm_password.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.confirm_password.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="button" class="btn btn-outline-secondary me-md-2" onclick="location.reload()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Resetuj
                                </button>
                                <button type="submit" class="btn btn-primary px-4" id="saveBtn">
                                    <span class="spinner-border spinner-border-sm me-2 d-none" id="loadingSpinner"></span>
                                    <i class="bi bi-check-lg me-2" id="saveIcon"></i>
                                    Zapisz zmiany
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Profile Stats -->
            <div class="col-lg-4">
                <!-- Account Status -->
                <div class="card border-0 shadow-sm glassmorphism mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Status konta</h5>
                        
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <span class="text-muted">Plan</span>
                            {% if current_user.is_premium_active() %}
                                <span class="badge bg-warning text-dark">Premium</span>
                            {% else %}
                                <span class="badge bg-secondary">Darmowy</span>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <span class="text-muted">Ostatnie logowanie</span>
                            <small class="text-end">
                                {% if current_user.last_login %}
                                    {{ current_user.last_login.strftime('%d.%m.%Y') }}<br>
                                    <span class="text-muted">{{ current_user.last_login.strftime('%H:%M') }}</span>
                                {% else %}
                                    Pierwsze logowanie
                                {% endif %}
                            </small>
                        </div>
                        
                        {% if not current_user.is_premium_active() %}
                        <hr>
                        <div class="text-center">
                            <button class="btn btn-warning btn-sm rounded-pill" onclick="showPremiumModal()">
                                <i class="bi bi-star me-1"></i>Przejdź na Premium
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="card border-0 shadow-sm glassmorphism">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Statystyki</h5>
                        
                        <div class="row g-3 text-center">
                            <div class="col-6">
                                <div class="p-3 bg-primary bg-opacity-10 rounded-3">
                                    <h4 class="h5 fw-bold text-primary mb-1">{{ current_user.uploads.count() }}</h4>
                                    <small class="text-muted">CV przesłanych</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-success bg-opacity-10 rounded-3">
                                    <h4 class="h5 fw-bold text-success mb-1">{{ current_user.uploads.filter_by(optimized_cv__ne=None).count() }}</h4>
                                    <small class="text-muted">Zoptymalizowanych</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-info bg-opacity-10 rounded-3">
                                    <h4 class="h5 fw-bold text-info mb-1">{{ current_user.uploads.filter_by(cv_analysis__ne=None).count() }}</h4>
                                    <small class="text-muted">Przeanalizowanych</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-warning bg-opacity-10 rounded-3">
                                    <h4 class="h5 fw-bold text-warning mb-1">{{ (now() - current_user.created_at).days }}</h4>
                                    <small class="text-muted">Dni z nami</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Toast Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong class="me-auto">Sukces</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="successMessage"></div>
    </div>
    
    <div id="errorToast" class="toast" role="alert">
        <div class="toast-header bg-danger text-white">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong class="me-auto">Błąd</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="errorMessage"></div>
    </div>
</div>

<style>
.profile-avatar {
    width: 80px;
    height: 80px;
    font-size: 1.5rem;
}

@media (max-width: 768px) {
    .profile-avatar {
        width: 60px;
        height: 60px;
        font-size: 1.2rem;
    }
}
</style>

<script>
document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const saveBtn = document.getElementById('saveBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const saveIcon = document.getElementById('saveIcon');
    const formData = new FormData(this);
    
    // Show loading state
    saveBtn.disabled = true;
    loadingSpinner.classList.remove('d-none');
    saveIcon.classList.add('d-none');
    
    try {
        const response = await fetch('/profile', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('success', result.message);
            // Clear password fields
            document.getElementById('current_password').value = '';
            document.getElementById('new_password').value = '';
            document.getElementById('confirm_password').value = '';
        } else {
            throw new Error(result.message);
        }
        
    } catch (error) {
        showToast('error', error.message);
    } finally {
        // Reset button state
        saveBtn.disabled = false;
        loadingSpinner.classList.add('d-none');
        saveIcon.classList.remove('d-none');
    }
});

function showToast(type, message) {
    const toast = type === 'success' ? 
        new bootstrap.Toast(document.getElementById('successToast')) :
        new bootstrap.Toast(document.getElementById('errorToast'));
    
    const messageElement = type === 'success' ? 
        document.getElementById('successMessage') :
        document.getElementById('errorMessage');
    
    messageElement.textContent = message;
    toast.show();
}

function showPremiumModal() {
    alert('Funkcja płatności będzie dostępna wkrótce!');
}
</script>
{% endblock %}
